program main
  implicit none
  real*8 :: clip(3,4) = reshape( &
       (/ -5.000000000000000000d-01, -5.000000000000000000d-01, 7.071067811865474617d-01, &
       5.000000000000000000d-01, -5.000000000000000000d-01, 7.071067811865474617d-01, &
       5.000000000000000000d-01, 5.000000000000000000d-01, 7.071067811865474617d-01, &
       -5.000000000000000000d-01, 5.000000000000000000d-01, 7.071067811865474617d-01 /), (/3,4/))
  real*8 :: nml(3,4) = reshape( &
       (/ 0.000000000000000000d+00, 8.164965809277260345d-01, 5.773502691896258421d-01, &
       -8.164965809277260345d-01, 0.000000000000000000d+00, 5.773502691896258421d-01, &
       0.000000000000000000d+00, -8.164965809277260345d-01, 5.773502691896258421d-01, &
       8.164965809277260345d-01, 0.000000000000000000d+00, 5.773502691896258421d-01 /), (/3,4/))
  real*8 :: poly(3,4) = reshape( &
       (/ 5.644736133437637804d-01, 5.644736133437637804d-01, 6.022782410790465946d-01, &
       3.127479665047677160d-01, -3.127479665047677160d-01, 8.968709042522592378d-01, &
       -5.644736133437637804d-01, -5.644736133437637804d-01, 6.022782410790465946d-01, &
       -3.127479665047677160d-01, 3.127479665047677160d-01, 8.968709042522592378d-01 /), (/3,4/))
  real*8 :: intersection(3,8) = reshape( &
       (/ 3.342826900143281987d-01, 5.441369567663348894d-01, 7.695258640473731093d-01, &
       4.999999999999998890d-01, 5.000000000000001110d-01, 7.071067811865476838d-01, &
       5.441369567663348894d-01, 3.342826900143283098d-01, 7.695258640473731093d-01, &
       3.127479665047677160d-01, -3.127479665047677160d-01, 8.968709042522592378d-01, &
       -3.342826900143280877d-01, -5.441369567663347784d-01, 7.695258640473732203d-01, &
       -5.000000000000000000d-01, -4.999999999999998890d-01, 7.071067811865474617d-01, &
       -5.441369567663348894d-01, -3.342826900143283098d-01, 7.695258640473731093d-01, &
       -3.127479665047677160d-01, 3.127479665047677160d-01, 8.968709042522592378d-01 /), (/3,8/))
  real*8 :: plane_intersection(2,8) = reshape( &
       (/ -5.000000000000000d-01, -3.397939048350230d-01, &
       -3.127479665047677d-01, 3.127479665047677d-01, &
       3.397939048350230d-01, 5.000000000000000d-01, &
       5.000000000000000d-01, 5.000000000000000d-01, &
       5.000000000000000d-01, 3.397939048350231d-01, &
       3.127479665047677d-01, -3.127479665047677d-01, &
       -3.397939048350231d-01, -5.000000000000000d-01, &
       -5.000000000000000d-01, -5.000000000000000d-01 /), (/2,8/))
  integer :: polyt(4) = (/ 0, 0, 0, 0 /)
  real*8 :: vo(3,20), rwrk(3,20)
  integer :: vto(20), iwrk(20)
  integer :: ncp = 4, np = 4, nvert = 20, no, info, i, j, cnt
  real*8 :: err

  call clipagainstpolysphere(clip, ncp, nml, poly, np, vo, no, rwrk, nvert, info)
  err = 0
  do i = 1,8
     do j = 1,3
        err = err + (vo(j,i) - intersection(j,i))**2
     end do
  end do
  err = sqrt(err)
  if (no /= 8) err = err + 1
  print *, 'sh  sphere err', err

  do i = 1,8
     do j = 1,3
        vo(j,i) = 0
     end do
  end do

  call clipagainstpolyplane(clip, ncp, nml, poly, np, vo, no, rwrk, nvert, info)
  err = 0
  do i = 1,8
     do j = 1,2
        err = err + (vo(j,i) - plane_intersection(j,mod(i+1,8)+1))**2
     end do
  end do
  err = sqrt(err)
  if (no /= 8) err = err + 1
  print *, 'sh  plane  err', err

  do i = 1,8
     do j = 1,3
        vo(j,i) = 0
     end do
  end do

  call iceclipagainstpolyplane(clip, ncp, nml, poly, polyt, np, vo, vto, no, &
       rwrk, iwrk, nvert, info)
  err = 0
  do i = 1,8
     do j = 1,2
        err = err + (vo(j,i) - plane_intersection(j,i))**2
     end do
  end do
  err = sqrt(err)
  if (no /= 8) err = err + 1
  print *, 'ice plane  err', err
end program main
